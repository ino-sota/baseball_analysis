<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é‡çƒãƒ‡ãƒ¼ã‚¿è§£æãƒ©ãƒœ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root { --primary: #0056b3; --bg: #f4f7f6; --card: #ffffff; --border: #e0e0e0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; background: var(--bg); color: #333; margin: 0; padding-bottom: 60px; }
  header { background: var(--primary); color: white; padding: 12px; text-align: center; font-weight: bold; }
  .container { max-width: 1100px; margin: 20px auto; padding: 0 10px; }
  .card { background: var(--card); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 15px; }
  .section-head { font-weight: bold; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
  
  /* Inputs */
  select, button { padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.95rem; }
  button { cursor: pointer; background: #f8f9fa; transition: 0.2s; }
  button:hover { background: #e2e6ea; }
  button.primary { background: var(--primary); color: white; border: none; }
  
  /* â–  è¿½åŠ : CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  .upload-area { background: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 2px dashed #ccc; text-align: center; font-size: 0.9rem; }
  
  /* Grid & Layout */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  @media (max-width: 768px) { .grid-2, .grid-4 { grid-template-columns: 1fr; } }

  /* Selection UI */
  .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; max-height: 250px; overflow-y: auto; padding: 5px; background: #fafafa; border: 1px solid #eee; }
  .check-item { display: flex; align-items: flex-start; gap: 8px; padding: 8px; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
  
  /* Mode Buttons */
  .mode-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; padding: 20px 0; }
  .mode-btn { width: 140px; height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; border: 2px solid #ddd; border-radius: 8px; color: #555; font-weight: bold; }
  .mode-btn:hover { border-color: var(--primary); color: var(--primary); background: #eef5fc; }

  /* Stats Boxes */
  .stat-box { background: #fdfdfd; border: 1px solid #eee; padding: 10px; text-align: center; border-radius: 5px; }
  .stat-val { font-size: 1.4rem; font-weight: bold; color: #333; }
  .stat-lbl { font-size: 0.75rem; color: #777; }
  
  /* Visuals: Heatmap */
  .zone-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; width: 200px; margin: 0 auto; background: #999; border: 2px solid #333; }
  .zone-cell { aspect-ratio: 1; background: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; position: relative; }
  .zone-cell.strike { border: 1px solid #bbb; }
  
  /* Visuals: Spray Chart */
  .field-wrap { position: relative; width: 260px; height: 260px; margin: 0 auto; background: #4caf50; border-radius: 8px; overflow: hidden; border: 2px solid #388e3c; }
  .field-svg { width: 100%; height: 100%; position: absolute; top:0; left:0; }
  .marker { position: absolute; transform: translate(-50%, -50%); z-index: 10; font-size: 12px; line-height: 1; }
  /* Spray Shapes */
  .marker.hit { color: #d32f2f; } /* Red for Hits */
  .marker.out { color: #1976d2; } /* Blue for Outs */
  
  /* Table */
  table.simple-tbl { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  table.simple-tbl th { background: #f1f1f1; padding: 6px; border: 1px solid #ddd; font-weight: normal; color: #555; }
  table.simple-tbl td { padding: 6px; border: 1px solid #ddd; text-align: center; }

  .hidden { display: none !important; }
  .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .legend-item { display: inline-flex; align-items: center; margin-right: 10px; font-size: 0.8rem; }
</style>
</head>
<body>

<div id="loading" class="loading">
  <div class="spinner"></div>
  <div style="margin-top:10px; font-weight:bold; color:var(--primary);">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<header>âš¾ é‡çƒãƒ‡ãƒ¼ã‚¿è§£æãƒ©ãƒœ</header>

<div class="container">

  <div class="card upload-area">
    <div style="font-weight:bold; margin-bottom:5px;">ğŸ“‚ éå»ãƒ‡ãƒ¼ã‚¿(CSV)ã®å–ã‚Šè¾¼ã¿</div>
    <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸCSVã‚’èª­ã¿è¾¼ã‚€ã¨ã€ç›´è¿‘ãƒ‡ãƒ¼ã‚¿ã¨åˆç®—ã—ã¦è§£æã§ãã¾ã™ã€‚</div>
    <input type="file" id="csv-file" accept=".csv" onchange="handleCsvUpload(this)" multiple>
    <div id="csv-status" style="margin-top:5px; font-weight:bold; color:#0056b3;"></div>
  </div>

  <div id="step-team" class="card">
    <div class="section-head">Step 1: ãƒãƒ¼ãƒ é¸æŠ</div>
    <div style="text-align:center;">
      <select id="team-select" onchange="onTeamSelected()" style="width:100%; max-width:400px;">
        <option value="">ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>
  </div>

  <div id="step-game" class="card hidden">
    <div class="section-head">Step 2: è©¦åˆé¸æŠ <div style="font-size:0.8rem;"><button onclick="toggleAllGames(true)">å…¨é¸æŠ</button> <button onclick="toggleAllGames(false)">å…¨è§£é™¤</button></div></div>
    <div id="game-list" class="selection-grid"></div>
    <div style="text-align:center; margin-top:15px;">
      <button class="primary" onclick="goToModeSelect()" style="width:200px;">æ¬¡ã¸</button>
    </div>
  </div>

  <div id="step-mode" class="card hidden">
    <div class="section-head">
      Step 3: ãƒ¢ãƒ¼ãƒ‰é¸æŠ
      <button onclick="backToGameSelect()" style="font-size:0.8rem;">æˆ»ã‚‹</button>
    </div>
    <div class="mode-container">
      <button class="mode-btn" onclick="startAnalysis('batter', 'top10')">ğŸ æ‰“è€…<br>æ‰“å¸­æ•°TOP 10</button>
      <button class="mode-btn" onclick="startAnalysis('batter', 'search')">ğŸ” æ‰“è€…<br>æ¤œç´¢</button>
      <button class="mode-btn" onclick="startAnalysis('pitcher', 'top5')">âš¾ æŠ•æ‰‹<br>æŠ•çƒå›TOP 5</button>
      <button class="mode-btn" onclick="startAnalysis('pitcher', 'search')">ğŸ” æŠ•æ‰‹<br>æ¤œç´¢</button>
    </div>
  </div>

  <div id="dashboard" class="hidden">
    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
      <button onclick="backToMode()">â† ãƒ¢ãƒ¼ãƒ‰é¸æŠã¸</button>
      <div id="mode-title" style="font-weight:bold; color:var(--primary);"></div>
    </div>

    <div class="card" id="list-card">
      <div id="player-buttons" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
      <div style="text-align:center; margin-top:5px;">
        <select id="player-search" class="hidden" onchange="renderStats(this.value)" style="width:100%; max-width:300px;"></select>
      </div>
    </div>

    <div id="stats-area" class="hidden">
      <div class="card">
        <h2 id="player-name" style="text-align:center; margin:0 0 15px 0; color:var(--primary);"></h2>
        <div id="main-stats-grid" class="grid-4" style="grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));">
          </div>
      </div>

      <div class="grid-2">
        <div>
          <div class="card" style="text-align:center;">
            <div class="section-head">æ‰“çƒæ–¹å‘ (Spray Chart)</div>
            <div style="margin-bottom:10px; font-size:0.8rem; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
              <label><input type="checkbox" id="spray-hit" checked onchange="updateVisuals()"> å®‰æ‰“(èµ¤)</label>
              <label><input type="checkbox" id="spray-out" checked onchange="updateVisuals()"> å‡¡æ‰“(é’)</label>
            </div>
            <div style="margin-bottom:5px; font-size:0.75rem;">
               â—ã‚´ãƒ­ â–²ãƒ•ãƒ©ã‚¤ â—†ãƒ©ã‚¤ãƒŠãƒ¼ âœ–ãƒãƒ³ãƒˆ
            </div>
            <div class="field-wrap">
              <svg class="field-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                <path d="M 50,85 L 85,50 A 45,45 0 0,0 15,50 Z" fill="#ccb57e" />
                <line x1="50" y1="85" x2="0" y2="35" stroke="white" stroke-width="0.5" />
                <line x1="50" y1="85" x2="100" y2="35" stroke="white" stroke-width="0.5" />
                <path d="M 0,35 A 60,60 0 0,1 100,35" fill="none" stroke="white" stroke-width="1" />
              </svg>
              <div id="spray-container"></div>
            </div>
          </div>

          <div class="card">
            <div class="section-head">çŠ¶æ³åˆ¥ãƒãƒ£ãƒ¼ãƒˆ</div>
            <div style="height:250px;">
              <canvas id="situation-chart"></canvas>
            </div>
          </div>
        </div>

        <div>
          <div class="card" style="text-align:center;">
            <div class="section-head">ã‚³ãƒ¼ã‚¹åˆ¥ãƒ‡ãƒ¼ã‚¿ (æ•æ‰‹è¦–ç‚¹)</div>
            <div style="margin-bottom:10px;">
              <select id="zone-mode" onchange="updateVisuals()">
                </select>
              <select id="zone-filter" onchange="updateVisuals()" class="hidden" style="margin-left:5px;">
                <option value="ALL">å…¨çƒç¨®</option>
                </select>
            </div>
            <div class="zone-container" id="zone-heatmap"></div>
          </div>

          <div class="card">
            <div class="section-head">çƒç¨®åˆ¥è©³ç´° / é€Ÿåº¦</div>
            <div id="detail-table-container"></div>
            <p style="font-size:0.7rem; color:#888; text-align:right; margin-top:5px;">â€»é€Ÿåº¦ã¯å¹³å‡Â±2æ¨™æº–åå·®ã®ç¯„å›²ã‚’é›†è¨ˆ</p>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// â– â– â–  è¨­å®š: ã“ã“ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸGASã®URLã‚’è²¼ã‚‹ â– â– â– 
const GAS_URL = "https://script.google.com/macros/s/AKfycbztZidK6NKz8jrTOeJkD6b07Qxn94sh2MsND3zOoiR8ViOl5Kn5XaI_tTxKPjwRLFO7/exec"; 

let ALL_DATA = [];
let TEAM_LIST = [];
let GAME_META = {};
let SELECTED_TEAM = "";
let SELECTED_GAMES = [];
let CURRENT_MODE = { role: "", type: "" }; 
let STATS_CACHE = {};
let CHART_INSTANCE = null;

window.onload = function() {
  if (GAS_URL.includes("YOUR_GAS")) { alert("HTMLå†…ã®GAS_URLã‚’è¨­å®šã—ã¦ãã ã•ã„"); return; }
  fetchData();
};

async function fetchData() {
  try {
    const res = await fetch(`${GAS_URL}?type=all_data`);
    const data = await res.json();
    if (data.teams && data.logs) {
      TEAM_LIST = data.teams;
      processRawData(data.logs);
    } else { alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼"); }
    document.getElementById('loading').classList.add('hidden');
    initTeamSelect();
  } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e); }
}

function processRawData(rows) {
  // GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚CSVã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã“ã“ã§çµ±åˆ
  // ALL_DATAã«çµåˆã™ã‚‹
  // é‡è¤‡æ’é™¤ãªã©ã¯ã—ã¦ã„ãªã„ãŸã‚ã€GameIDã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ç°¡æ˜“çš„ã«è¿½åŠ ã—ã¦ã„ã
  rows.forEach(r => {
      ALL_DATA.push(r); // è¿½åŠ 
      // 0:ID, 1:P, 2:B, 3:Inn, 4:Count/Meta, 13:Name
      if (r[1] === "SYSTEM_LINEUP") {
        try {
          // CSVã®å ´åˆã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆãŒäºŒé‡ã«ãªã£ã¦ã„ã‚‹å ´åˆãªã©ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—è§£é™¤ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ãŒ
          // JSON.parseãŒé€šã‚Œã°OK
          const meta = JSON.parse(r[4]);
          GAME_META[r[0]] = { top: meta.topTeam, btm: meta.btmTeam, name: r[13], date: new Date(r[13]).toLocaleDateString() };
        } catch(e){}
      }
  });
  
  // ãƒãƒ¼ãƒ ãƒªã‚¹ãƒˆã®æ›´æ–°ï¼ˆCSVã«å«ã¾ã‚Œã‚‹æ–°ã—ã„ãƒãƒ¼ãƒ ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ãŸã‚ï¼‰
  updateTeamListFromData();
}

function updateTeamListFromData() {
    // GAME_METAã‹ã‚‰ãƒãƒ¼ãƒ åã‚’æŠ½å‡ºã—ã¦TEAM_LISTã‚’æ›´æ–°
    let teams = new Set(TEAM_LIST);
    Object.values(GAME_META).forEach(m => {
        if(m.top) teams.add(m.top);
        if(m.btm) teams.add(m.btm);
    });
    TEAM_LIST = Array.from(teams).sort();
    
    // ç¾åœ¨é¸æŠä¸­ã®ãƒãƒ¼ãƒ ãŒã‚ã‚Œã°ç¶­æŒã€ãªã‘ã‚Œã°å†æç”»
    const sel = document.getElementById('team-select');
    const current = sel.value;
    initTeamSelect();
    if(current) sel.value = current;
}

// â– â– â–  è¿½åŠ : CSVèª­ã¿è¾¼ã¿å‡¦ç† â– â– â– 
function handleCsvUpload(input) {
  if (input.files.length === 0) return;
  const files = Array.from(input.files);
  let loadedCount = 0;

  document.getElementById('csv-status').innerText = "èª­ã¿è¾¼ã¿ä¸­...";

  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const rows = parseCSV(text);
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œåˆ¤å®šï¼ˆç°¡æ˜“çš„ï¼š1åˆ—ç›®ãŒ"Timestamp"ã‚„"Date"ãªã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã¿ãªã™ï¼‰
      // GASã®é…åˆ—ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã§æ¥ã‚‹å‰æã ãŒã€CSVã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚‹ã“ã¨ãŒå¤šã„
      let startIndex = 0;
      if (rows.length > 0 && (rows[0][0].includes("Timestamp") || rows[0][0].includes("æ—¥ä»˜"))) {
         startIndex = 1;
      }
      
      // Båˆ—(index 1)ã‹ã‚‰Oåˆ—(index 14)ã¾ã§æŠ½å‡ºã—ã¦ã€GASã®ãƒ­ã‚°å½¢å¼ã«åˆã‚ã›ã‚‹
      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’CSVã«ã™ã‚‹ã¨ã€Aåˆ—(Timestamp)ã‹ã‚‰å§‹ã¾ã‚‹ã“ã¨ãŒå¤šã„ã€‚
      // GASã® logs ãƒ‡ãƒ¼ã‚¿ã¯ Båˆ—(GameID) ã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹ã€‚
      // ã“ã“ã§åˆ—ã‚ºãƒ¬ã‚’è£œæ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
      // ãƒ‡ãƒ¼ã‚¿ã®1åˆ—ç›®ãŒæ—¥ä»˜ã£ã½ã„å½¢å¼ãªã‚‰Aåˆ—ã‚ã‚Šã¨åˆ¤æ–­ã—ã¦shiftã™ã‚‹ã€‚
      
      const formattedRows = [];
      for(let i = startIndex; i < rows.length; i++) {
         let row = rows[i];
         if(row.length < 5) continue; // ç©ºè¡Œãªã©ã¯ã‚¹ã‚­ãƒƒãƒ—
         
         // Aåˆ—ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€å‰Šé™¤ã—ã¦GASã®å½¢å¼(GameIDå§‹ã¾ã‚Š)ã«åˆã‚ã›ã‚‹
         // åˆ¤å®šï¼šrow[0]ãŒæ—¥ä»˜æ™‚åˆ»ã£ã½ã„ã€ã‹ã¤row[1]ãŒGAME-XXX
         if (row[0].match(/\d{4}\/\d{1,2}\/\d{1,2}/) || row[1].includes("GAME-")) {
            // Aåˆ—ã‚’æ¨ã¦ã¦ã€Båˆ—ä»¥é™ã‚’ä½¿ã†
            // GASã®é…åˆ—: [GameID, Pitcher, Batter, Inn, Count, Ball, CX, CY, Res, Qual, HX, HY, Spd, Name]
            // CSV: [Time, GameID, Pitcher, Batter, Inn, Count, Ball, CX, CY, Res, Qual, HX, HY, Spd, Name]
             row.shift(); 
         }
         formattedRows.push(row);
      }
      
      processRawData(formattedRows);
      loadedCount++;
      
      if(loadedCount === files.length) {
         document.getElementById('csv-status').innerText = `${files.length}ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿å®Œäº†!`;
         // ç”»é¢ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
         if(SELECTED_TEAM) {
             onTeamSelected(); // è©¦åˆãƒªã‚¹ãƒˆå†æç”»
         } else {
             initTeamSelect();
         }
      }
    };
    reader.readAsText(file);
  });
}

// ã‚«ãƒ³ãƒã‚’å«ã‚€CSVã‚’æ­£ã—ããƒ‘ãƒ¼ã‚¹ã™ã‚‹é–¢æ•°
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentCell = "";
    let inQuote = false;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (inQuote) {
            if (char === '"' && nextChar === '"') {
                currentCell += '"';
                i++; // Skip next quote
            } else if (char === '"') {
                inQuote = false;
            } else {
                currentCell += char;
            }
        } else {
            if (char === '"') {
                inQuote = true;
            } else if (char === ',') {
                currentRow.push(currentCell);
                currentCell = "";
            } else if (char === '\n' || char === '\r') {
                if (currentCell || currentRow.length > 0) {
                    currentRow.push(currentCell);
                    rows.push(currentRow);
                }
                currentRow = [];
                currentCell = "";
                if (char === '\r' && nextChar === '\n') i++; // Handle CRLF
            } else {
                currentCell += char;
            }
        }
    }
    if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell);
        rows.push(currentRow);
    }
    return rows;
}

function initTeamSelect() {
  const s = document.getElementById('team-select');
  s.innerHTML = '<option value="">ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
  TEAM_LIST.forEach(t => s.add(new Option(t, t)));
}
function onTeamSelected() {
  SELECTED_TEAM = document.getElementById('team-select').value;
  if(SELECTED_TEAM) {
    document.getElementById('step-game').classList.remove('hidden');
    renderGameList();
  }
}
function renderGameList() {
  const c = document.getElementById('game-list'); c.innerHTML = "";
  const ids = Object.keys(GAME_META).filter(id => {
    const m = GAME_META[id]; return m.top === SELECTED_TEAM || m.btm === SELECTED_TEAM;
  }).reverse();
  if(ids.length===0) c.innerHTML = "<div style='padding:10px;'>è©¦åˆè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>";
  ids.forEach(id => {
    const m = GAME_META[id];
    const d = document.createElement('div'); d.className = 'check-item';
    d.innerHTML = `<input type="checkbox" class="g-chk" value="${id}" checked> <div><b>${m.name}</b><br><span style="color:#666;font-size:0.8rem">${m.date}</span></div>`;
    c.appendChild(d);
  });
}
function toggleAllGames(v) { document.querySelectorAll('.g-chk').forEach(e=>e.checked=v); }

function goToModeSelect() {
  SELECTED_GAMES = Array.from(document.querySelectorAll('.g-chk:checked')).map(e=>e.value);
  if(SELECTED_GAMES.length===0) { alert("è©¦åˆã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  document.getElementById('step-team').classList.add('hidden');
  document.getElementById('step-game').classList.add('hidden');
  document.getElementById('step-mode').classList.remove('hidden');
}
function backToGameSelect() {
  document.getElementById('step-mode').classList.add('hidden');
  document.getElementById('step-game').classList.remove('hidden');
  document.getElementById('step-team').classList.remove('hidden');
}
function backToMode() {
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('stats-area').classList.add('hidden');
  document.getElementById('step-mode').classList.remove('hidden');
}

function startAnalysis(role, type) {
  CURRENT_MODE = { role, type };
  document.getElementById('step-mode').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('mode-title').innerText = `${SELECTED_TEAM} ${role==='batter'?'æ‰“è€…':'æŠ•æ‰‹'}`;
  
  // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®é¸æŠè‚¢è¨­å®š
  const zm = document.getElementById('zone-mode');
  zm.innerHTML = "";
  if (role === 'batter') {
    zm.add(new Option("ã‚³ãƒ¼ã‚¹åˆ¥æ‰“ç‡", "avg"));
    zm.add(new Option("ã‚³ãƒ¼ã‚¹åˆ¥ã‚¹ã‚¤ãƒ³ã‚°ç‡", "swing"));
    document.getElementById('zone-filter').classList.add('hidden');
  } else {
    // æŠ•æ‰‹
    zm.add(new Option("ã‚³ãƒ¼ã‚¹å‰²åˆ (çƒç¨®é¸æŠå¯)", "rate"));
    document.getElementById('zone-filter').classList.remove('hidden');
  }

  aggregateStats(role);
  renderPlayerList();
}

function aggregateStats(role) {
  STATS_CACHE = {};
  const isBat = (role === 'batter');
  
  const targetLogs = ALL_DATA.filter(r => {
    if(!SELECTED_GAMES.includes(r[0])) return false;
    if(r[1]==="SYSTEM_LINEUP" || r[8]==="GAME_START") return false;
    const m = GAME_META[r[0]]; if(!m) return false;
    const isTop = r[3].includes("è¡¨");
    const atk = isTop ? m.top : m.btm;
    return isBat ? (atk === SELECTED_TEAM) : (atk !== SELECTED_TEAM);
  });

  targetLogs.forEach(r => {
    const name = isBat ? r[2] : r[1];
    if(!name) return;
    if(!STATS_CACHE[name]) STATS_CACHE[name] = initStatObj();
    calcStat(STATS_CACHE[name], r, isBat);
  });
}

function initStatObj() {
  return {
    pa:0, ab:0, h:0, h2:0, h3:0, hr:0, bb:0, so:0, outs:0, pitches:0,
    courses: Array(26).fill(0).map(()=>({tot:0, hit:0, swing:0, typeCount:{}})),
    balls: {}, // { Straight: {tot, swing, hit, speed:[]} }
    counts: {}, // { "0-0": {tot, swing, typeCount:{}} }
    results: [] // Spray data
  };
}

function calcStat(s, r, isBat) {
  // 5:Ball, 6:CX, 8:Res, 9:Qual, 10:HX, 11:HY, 12:Spd
  const ball = r[5] || "ä¸æ˜";
  const cx = parseInt(r[6]); // CSVã‹ã‚‰ã¯æ–‡å­—åˆ—ã§æ¥ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§intå¤‰æ›
  const res = r[8] ? r[8].replace(/\r?\n/g,'') : "";
  const spd = parseInt(r[12]);
  const cnt = r[4] || "ä¸æ˜";

  s.pitches++;

  // çƒç¨®åˆ¥ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
  if(!s.balls[ball]) s.balls[ball] = {tot:0, swing:0, hit:0, speed:[]};
  s.balls[ball].tot++;
  if(!isNaN(spd) && spd > 60) s.balls[ball].speed.push(spd);

  // ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
  if(!s.counts[cnt]) s.counts[cnt] = {tot:0, swing:0, typeCount:{}};
  s.counts[cnt].tot++;
  if(!s.counts[cnt].typeCount[ball]) s.counts[cnt].typeCount[ball] = 0;
  s.counts[cnt].typeCount[ball]++;

  // ã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿
  if(cx>=1 && cx<=25) {
    s.courses[cx].tot++;
    if(!s.courses[cx].typeCount[ball]) s.courses[cx].typeCount[ball] = 0;
    s.courses[cx].typeCount[ball]++;
  }

  // ã‚¹ã‚¤ãƒ³ã‚°åˆ¤å®š
  const isSwing = ["ç©ºæŒ¯ã‚Š","ãƒ•ã‚¡ãƒ¼ãƒ«","å®‰æ‰“","ã‚´ãƒ­","ãƒ•ãƒ©ã‚¤","ãƒ©ã‚¤ãƒŠãƒ¼","æœ¬å¡æ‰“","äºŒå¡æ‰“","ä¸‰å¡æ‰“"].some(k=>res.includes(k)) || res.includes("æ‰“");
  if(isSwing) {
    s.balls[ball].swing++;
    s.counts[cnt].swing++;
    if(cx>=1 && cx<=25) s.courses[cx].swing++;
  }

  // çµæœåˆ¤å®š (æœ€çµ‚çƒã®ã¿)
  let isHit = false;
  if(res.includes("å®‰æ‰“")||res.includes("æœ¬å¡æ‰“")||res.includes("äºŒå¡æ‰“")||res.includes("ä¸‰å¡æ‰“")) {
    s.pa++; s.ab++; s.h++; isHit=true;
    s.balls[ball].hit++;
    if(res.includes("äºŒå¡æ‰“")) s.h2++;
    if(res.includes("æœ¬å¡æ‰“")) s.hr++;
    if(cx>=1 && cx<=25) s.courses[cx].hit++;
  } else if(res.includes("å››çƒ")||res.includes("æ­»çƒ")) {
    s.pa++; s.bb++;
  } else if(res.includes("çŠ ")) {
    s.pa++;
  } else if(res.includes("ã‚¢ã‚¦ãƒˆ")||res.includes("å¤±ç­–")||res.includes("ä½µæ®º")||res.includes("ä¸‰æŒ¯")||res.includes("æ‰“")||res.includes("ã‚´ãƒ­")||res.includes("ãƒ•ãƒ©ã‚¤")) {
    // å‡¡æ‰“ç³»
    if(!res.includes("ãƒœãƒ¼ãƒ«")&&!res.includes("è¦‹é€ƒã—")&&!res.includes("ç©ºæŒ¯ã‚Š")&&!res.includes("ãƒ•ã‚¡ãƒ¼ãƒ«")) {
      s.pa++; s.ab++; s.outs++;
      if(res.includes("ä½µæ®º")) s.outs++;
      if(res.includes("ä¸‰é‡æ®º")) s.outs+=2;
      if(res.includes("ä¸‰æŒ¯")) s.so++;
    }
  }

  // ãƒ—ãƒ­ãƒƒãƒˆ (Quality: ã‚´ãƒ­, ãƒ•ãƒ©ã‚¤, ãƒ©ã‚¤ãƒŠãƒ¼, ãƒãƒ³ãƒˆ)
  if(r[10] && r[11]) {
    s.results.push({ x:r[10], y:r[11], type:isHit?'hit':'out', qual:r[9]||"ä¸æ˜" });
  }
}

function renderPlayerList() {
  const c = document.getElementById('player-buttons');
  const sel = document.getElementById('player-search');
  c.innerHTML = ""; sel.innerHTML = "<option value=''>é¸æ‰‹ã‚’é¸æŠ...</option>";
  
  const isBat = (CURRENT_MODE.role === 'batter');
  let arr = Object.keys(STATS_CACHE).map(n => ({ n, d: STATS_CACHE[n], val: isBat ? STATS_CACHE[n].pa : STATS_CACHE[n].outs }));
  arr.sort((a,b) => b.val - a.val);

  if (CURRENT_MODE.type.includes('top')) {
    const limit = isBat ? 10 : 5;
    arr.slice(0, limit).forEach(p => {
      const btn = document.createElement('button');
      btn.style.width = "auto"; btn.style.padding = "10px";
      const sub = isBat ? `${p.val}æ‰“å¸­` : `${(p.val/3).toFixed(1)}å›`;
      btn.innerHTML = `<b>${p.n}</b><br><span style="font-size:0.8rem;color:#666">${sub}</span>`;
      btn.onclick = () => renderStats(p.n);
      c.appendChild(btn);
    });
    document.getElementById('player-search').classList.add('hidden');
    if(arr.length>0) renderStats(arr[0].n);
  } else {
    arr.forEach(p => sel.add(new Option(p.n, p.n)));
    document.getElementById('player-search').classList.remove('hidden');
  }
}

let CURRENT_DATA = null;
function renderStats(name) {
  if(!name) return;
  CURRENT_DATA = STATS_CACHE[name];
  document.getElementById('stats-area').classList.remove('hidden');
  document.getElementById('player-name').innerText = name;
  
  const d = CURRENT_DATA;
  const isBat = (CURRENT_MODE.role === 'batter');
  const avg = d.ab>0 ? (d.h/d.ab).toFixed(3).replace(/^0/,'') : ".000";
  const inn = Math.floor(d.outs/3) + (d.outs%3===0?"":d.outs%3===1?".1":".2");
  
  // ãƒ¡ã‚¤ãƒ³æŒ‡æ¨™ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
  const box = (l, v) => `<div class="stat-box"><div class="stat-val">${v}</div><div class="stat-lbl">${l}</div></div>`;
  let h = "";
  if(isBat) {
    h += box("æ‰“å¸­", d.pa) + box("æ‰“ç‡", avg) + box("æ‰“æ•°", d.ab) + box("å®‰æ‰“", d.h);
    h += box("2å¡æ‰“", d.h2) + box("æœ¬å¡æ‰“", d.hr) + box("å››æ­»çƒ", d.bb) + box("ä¸‰æŒ¯", d.so);
  } else {
    h += box("æŠ•çƒå›", inn) + box("è¢«æ‰“ç‡", d.ab>0?(d.h/d.ab).toFixed(3).replace(/^0/,''):".000");
    h += box("å¥ªä¸‰æŒ¯", d.so) + box("è¢«å®‰æ‰“", d.h) + box("ä¸å››æ­»çƒ", d.bb) + box("å¯¾å³ç‡", "-") + box("å¯¾å·¦ç‡", "-");
  }
  document.getElementById('main-stats-grid').innerHTML = h;
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–° (æŠ•æ‰‹ç”¨)
  if(!isBat) {
    const sel = document.getElementById('zone-filter');
    sel.innerHTML = "<option value='ALL'>å…¨çƒç¨®</option>";
    Object.keys(d.balls).forEach(k => sel.add(new Option(k, k)));
  }

  updateVisuals();
  renderChart(d, isBat);
  renderTable(d, isBat);
}

function updateVisuals() {
  if(!CURRENT_DATA) return;
  // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
  const zc = document.getElementById('zone-heatmap'); zc.innerHTML = "";
  const mode = document.getElementById('zone-mode').value;
  const filter = document.getElementById('zone-filter').value;
  
  for(let i=1; i<=25; i++) {
    const c = CURRENT_DATA.courses[i];
    const div = document.createElement('div');
    div.className = 'zone-cell';
    if([7,8,9,12,13,14,17,18,19].includes(i)) div.classList.add('strike');
    
    let val = 0, text = "";
    if (c.tot > 0) {
      if (mode === 'avg') { // æ‰“ç‡
        val = c.hit / c.tot; text = `.${Math.round(val*1000)}`;
      } else if (mode === 'swing') { // ã‚¹ã‚¤ãƒ³ã‚°ç‡
        val = c.swing / c.tot; text = `${Math.round(val*100)}%`;
      } else if (mode === 'rate') { // ã‚³ãƒ¼ã‚¹å‰²åˆ (æŠ•æ‰‹)
        // ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸçƒç¨®ã®ç·æ•°ã«å¯¾ã™ã‚‹ã“ã®ã‚³ãƒ¼ã‚¹ã®å‰²åˆ
        let targetCount = (filter === 'ALL') ? c.tot : (c.typeCount[filter] || 0);
        let totalTarget = 0;
        CURRENT_DATA.courses.forEach(cc => totalTarget += (filter==='ALL'?cc.tot:(cc.typeCount[filter]||0)));
        if (totalTarget > 0 && targetCount > 0) {
          val = targetCount / totalTarget;
          text = `${Math.round(val*100)}%`;
          // æŠ•æ‰‹ç”¨ã¯è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚å¼·èª¿
          val = val * 3; // 33%ã§MAXã«ãªã‚‹ãã‚‰ã„ã«è£œæ­£
        }
      }
      if(text) {
        div.style.backgroundColor = `rgba(255,0,0,${Math.min(val, 1)})`;
        if(val>0.5) div.style.color="white";
        div.innerText = text;
      }
    }
    zc.appendChild(div);
  }

  // ã‚¹ãƒ—ãƒ¬ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
  const sc = document.getElementById('spray-container'); sc.innerHTML = "";
  const sHit = document.getElementById('spray-hit').checked;
  const sOut = document.getElementById('spray-out').checked;
  
  CURRENT_DATA.results.forEach(r => {
    if(r.type==='hit' && !sHit) return;
    if(r.type==='out' && !sOut) return;
    
    const d = document.createElement('div');
    d.className = `marker ${r.type}`;
    d.style.left = r.x + "%"; d.style.top = r.y + "%";
    
    // å½¢çŠ¶å¤‰åŒ–
    let mark = "â—"; // ã‚´ãƒ­(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
    if(r.qual.includes("ãƒ•ãƒ©ã‚¤")) mark = "â–²";
    if(r.qual.includes("ãƒ©ã‚¤ãƒŠãƒ¼")) mark = "â—†";
    if(r.qual.includes("ãƒãƒ³ãƒˆ")) mark = "âœ–";
    d.innerHTML = mark;
    sc.appendChild(d);
  });
}

function renderChart(d, isBat) {
  const ctx = document.getElementById('situation-chart').getContext('2d');
  if(CHART_INSTANCE) CHART_INSTANCE.destroy();

  const labels = Object.keys(d.counts).sort();
  
  if (isBat) {
    // æ‰“è€…: ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã‚¹ã‚¤ãƒ³ã‚°ç‡ (æŠ˜ã‚Œç·š or æ£’)
    const data = labels.map(k => d.counts[k].tot>0 ? (d.counts[k].swing/d.counts[k].tot*100) : 0);
    CHART_INSTANCE = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'ã‚«ã‚¦ãƒ³ãƒˆåˆ¥ã‚¹ã‚¤ãƒ³ã‚°ç‡(%)', data: data, backgroundColor: '#0056b3' }]
      },
      options: { responsive:true, maintainAspectRatio:false, scales:{y:{max:100}} }
    });
  } else {
    // æŠ•æ‰‹: ã‚«ã‚¦ãƒ³ãƒˆåˆ¥çƒç¨®å‰²åˆ (ç©ã¿ä¸Šã’æ£’)
    const allTypes = Object.keys(d.balls);
    const datasets = allTypes.map((t, i) => {
      const colors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0'];
      return {
        label: t,
        data: labels.map(cnt => {
           const c = d.counts[cnt];
           return c.tot>0 ? ((c.typeCount[t]||0)/c.tot*100) : 0;
        }),
        backgroundColor: colors[i % colors.length]
      };
    });

    CHART_INSTANCE = new Chart(ctx, {
      type: 'bar',
      data: { labels: labels, datasets: datasets },
      options: { 
        responsive:true, maintainAspectRatio:false,
        scales:{ x:{stacked:true}, y:{stacked:true, max:100} },
        plugins: { tooltip: { callbacks: { label: (c)=>` ${c.dataset.label}: ${Math.round(c.raw)}%` } } }
      }
    });
  }
}

function renderTable(d, isBat) {
  const div = document.getElementById('detail-table-container');
  let h = `<table class="simple-tbl">`;
  
  if (isBat) {
    h += `<tr><th>çƒç¨®</th><th>æ‰“ç‡</th><th>ã‚¹ã‚¤ãƒ³ã‚°ç‡</th></tr>`;
    for(const t in d.balls) {
      const b = d.balls[t];
      const avg = b.tot>0 ? (b.hit/b.tot).toFixed(3).replace(/^0/,'') : "-"; // æ­£ç¢ºãªæ‰“æ•°ã¯çƒç¨®åˆ¥ã«å‡ºã›ãªã„ã®ã§ã€Œå®‰æ‰“/çƒæ•°ã€ã§ä»£ç”¨ã™ã‚‹ã‹ã€ç©ºæ¬„ã«ã™ã‚‹ãŒã€è¦ä»¶ã¯ã€Œçƒç¨®åˆ¥æ‰“ç‡ã€ã€‚æ¯æ•°ãŒæ‰“æ•°ã˜ã‚ƒãªã„ã®ã§å‚è€ƒå€¤ã«ãªã‚‹
      // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿çš„ã«ã€Œãƒœãƒ¼ãƒ«ã€ã¯æ‰“æ•°ã«å«ã¾ã‚Œãªã„ãŒã€ã“ã“ã§ã¯å˜ç´”åŒ–ã—ã¦è¡¨ç¤º
      const sw = b.tot>0 ? Math.round(b.swing/b.tot*100)+"%" : "-";
      h += `<tr><td>${t}</td><td>${avg}</td><td>${sw}</td></tr>`;
    }
  } else {
    h += `<tr><th>çƒç¨®</th><th>å¹³å‡(km/h)</th><th>Max</th><th>æŠ•çƒæ•°</th></tr>`;
    for(const t in d.balls) {
      const b = d.balls[t];
      const spds = b.speed;
      let avg = "-", max = "-";
      if(spds.length > 0) {
        const sum = spds.reduce((a,v)=>a+v,0);
        const mean = sum/spds.length;
        const sd = Math.sqrt(spds.map(x=>Math.pow(x-mean,2)).reduce((a,v)=>a+v,0)/spds.length);
        const clean = spds.filter(x => Math.abs(x-mean) <= 2*sd);
        if(clean.length) avg = (clean.reduce((a,v)=>a+v,0)/clean.length).toFixed(1);
        max = Math.max(...clean);
      }
      h += `<tr><td>${t}</td><td>${avg}</td><td>${max}</td><td>${b.tot}</td></tr>`;
    }
  }
  h += `</table>`;
  div.innerHTML = h;
}
</script>
</body>
</html>
